var printer=null;var ePosDev=null;var printCallback=null;function cbConnect(a){if(a=="OK"||a=="SSL_CONNECT_OK"){ePosDev.createDevice($("#setting-devid").val(),ePosDev.DEVICE_TYPE_PRINTER,{crypto:false,buffer:false},cbCreateDevice_printer)}else{addPrintInfo(message.epos_error+" ("+a+")")}}function cbCreateDevice_printer(b,a){if(a=="OK"){printer=b;printer.timeout=$("#setting-timeout").val();printer.onreceive=function(c){if(c.printjobid.length>0){addPrintInfo((c.success?message.success+" (":message.failure+" ("+message.epos_code+": "+c.code+", ")+message.epos_jobid+": "+c.printjobid+")")}else{addPrintInfo(c.success?message.success:message.failure+" ("+message.epos_code+": "+c.code+")")}};printer.onerror=function(c){addPrintInfo(message.epos_error+" ("+message.epos_status+": "+c.status+")")};printer.ononline=function(){addPrintInfo(message.epos_online)};printer.onoffline=function(){addPrintInfo(message.epos_offline)};printer.onpoweroff=function(){addPrintInfo(message.epos_poweroff)};printer.oncoverok=function(){addPrintInfo(message.epos_coverok)};printer.oncoveropen=function(){addPrintInfo(message.epos_coveropen)};printer.onpaperok=function(){addPrintInfo(message.epos_paperok)};printer.onpapernearend=function(){addPrintInfo(message.epos_papernearend)};printer.onpaperend=function(){addPrintInfo(message.epos_paperend)};printer.ondrawerclosed=function(){addPrintInfo(message.epos_drawerclosed)};printer.ondraweropen=function(){addPrintInfo(message.epos_draweropen)};printer.onbatterylow=function(){addPrintInfo(message.epos_batterylow)};printer.onbatteryok=function(){addPrintInfo(message.epos_batteryok)};printer.onbatterystatuschange=function(c){if(c>0){addPrintInfo(message.epos_batterystatus+": 0x"+("000"+c.toString(16)).slice(-4))}};setStatusMonitor();if(printCallback){printCallback();printCallback=null}}else{addPrintInfo(message.epos_error+" ("+a+")")}}function connectPrinter(){ePosDev=new epson.ePOSDevice();ePosDev.ondisconnect=function(){printer=null};$(window).bind("beforeunload",function(a){return message.unload});ePosDev.connect($("#setting-ipaddr").val(),$("#setting-port").val(),cbConnect)}function setPrintDoc(a){$("#print-doc").val(a)}function sendPrintDoc(){if(printer){doSendPrintDoc()}else{printCallback=doSendPrintDoc;connectPrinter()}}function doSendPrintDoc(){var a;if(printer){try{a=$($.parseXML($("#print-doc").val())).find("epos-print");if(a.size()==0){throw new Error(message.import_noelem)}if(/^(1|true)$/.test(a.attr("force"))){printer.force=true}printer.setXmlString($("#print-doc").val().replace(/< *\/? *epos-print(.+\".*?\")* *>/g,""))}catch(b){addPrintInfo(message.epos_error+" ("+b.message+")");return}if($("#setting-jobid").is(":checked")){now=new Date();jobid="E"+now.getHours()+("0"+now.getMinutes()).slice(-2)+("0"+now.getSeconds()).slice(-2)+("00"+now.getMilliseconds()).slice(-3);printer.send(jobid);addPrintInfo(message.epos_send+" ("+message.epos_jobid+": "+jobid+")")}else{printer.send();addPrintInfo(message.epos_send)}}else{addPrintInfo(message.epos_error)}}function setStatusMonitor(){if(printer){if($("#setting-status").is(":checked")){if(!printer.enabled){printer.startMonitor();addPrintInfo(message.epos_open)}}else{if(printer.enabled){printer.stopMonitor();addPrintInfo(message.epos_close)}}if($("#setting-drawer").val()=="high"){printer.drawerOpenLevel=printer.DRAWER_OPEN_LEVEL_HIGH}else{printer.drawerOpenLevel=printer.DRAWER_OPEN_LEVEL_LOW}}}function addPrintInfo(d){var b=new Date(),a=[b.getFullYear(),("0"+(b.getMonth()+1)).slice(-2),("0"+b.getDate()).slice(-2)].join("-"),c=[b.getHours(),("0"+b.getMinutes()).slice(-2),("0"+b.getSeconds()).slice(-2)].join(":");$("#print-info").val($("#print-info").val()+a+" "+c+" "+d+"\n").change()};