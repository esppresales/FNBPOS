var color_convert={none:"#ffffff",color_1:"#000000",color_2:"#c00000",color_3:"#00c000",color_4:"#0000c0"};var line_convert={thin:{w:1,d:false},medium:{w:2,d:false},thick:{w:4,d:false},thin_double:{w:1,d:true},medium_double:{w:2,d:true},thick_double:{w:4,d:true}};var dir_convert={left_to_right:{x:0,y:0,r:0,w:true},top_to_bottom:{x:1,y:0,r:Math.PI*0.5000001,w:false},right_to_left:{x:1,y:1,r:Math.PI,w:true},bottom_to_top:{x:0,y:1,r:Math.PI*1.5000001,w:false}};var model=modelinfo.tm_t88_80;var align="left";var linespc=30;var rotate=false;var line_x=0;var line_y=191;var line_w=0;var line_h=0;var text_l="en";var text_f="font_a";var text_s=false;var text_w=1;var text_h=1;var text_r=false;var text_u=false;var text_e=false;var text_c=color_convert.color_1;var font_a=24;var font_k=24;var hline=[];var vline=[];var page=false;var page_linespc=30;var page_h=0;var area_x=0;var area_y=0;var area_w=512;var area_h=831;var area_valid=false;var page_dir=dir_convert.left_to_right;var page_x=0;var page_y=23;function drawPreview(){var a=new epson.ePOSBuilder(),b,e;model=modelinfo[$("#setting-model").val()];align="left";linespc=model.linespc;rotate=false;line_x=0;line_y=191;line_w=0;line_h=0;text_l="en";text_f="font_a";text_s=false;text_w=1;text_h=1;text_r=false;text_u=false;text_e=false;text_c=color_convert.color_1;font_a=24;font_k=24;hline=[];vline=[];page=false;page_linespc=model.linespc;b=$("#preview-text").get(0);if(b.getContext){e=b.getContext("2d");e.clearRect(0,0,b.width,b.height)}$("#preview-paper canvas").remove();$("#preview-paper").width(model.width);$("#preview-width span").text(model.width);$("#preview-width img:eq(1)").attr("width",model.width-2);$("#edit-sequence li").each(function(){var n=$(this),g,f,h,m,l,k,j,i;if(n.hasClass("epos-text-align")){m=a[n.find(".attr-text-align").val()];if(page){align=m}else{if(line_w==0&&line_x==0){align=m}}}else{if(n.hasClass("epos-text-linespc")){m=n.find(".attr-text-linespc").val()-0;if(page){page_linespc=m}else{linespc=m}}else{if(n.hasClass("epos-text-rotate")){m=n.find(".attr-text-rotate").is(":checked");if(page){rotate=m}else{if(line_w==0&&line_x==0){rotate=m}}}else{if(n.hasClass("epos-text-lang")){text_l=n.find(".attr-text-lang").val()}else{if(n.hasClass("epos-text-font")){text_f=a[n.find(".attr-text-font").val()]}else{if(n.hasClass("epos-text-position")){m=n.find(".attr-text-x").val()-0;if(page){if(m<(page_dir.w?area_w:area_h)){page_x=m}}else{if(m<model.width){line_x=m}}}else{if(n.hasClass("epos-text-vposition")){m=n.find(".attr-text-y").val()-0;if(page){if(m<(page_dir.w?area_h:area_w)){page_y=m}}else{}}else{if(n.hasClass("epos-text-smooth")){text_s=n.find(".attr-text-smooth").is(":checked")}else{if(n.hasClass("epos-text-size")){text_w=n.find(".attr-text-width").val()-0;text_h=n.find(".attr-text-height").val()-0}else{if(n.hasClass("epos-text-double")){text_w=n.find(".attr-text-dw").is(":checked")?2:1;text_h=n.find(".attr-text-dh").is(":checked")?2:1}else{if(n.hasClass("epos-text-style")){text_r=n.find(".attr-text-reverse").is(":checked");text_u=n.find(".attr-text-ul").is(":checked");text_e=n.find(".attr-text-em").is(":checked");text_c=color_convert[a[n.find(".attr-text-color").val()]]}else{if(n.hasClass("epos-text")){m=escapeText(n.find(".attr-text-data").val());if(page){drawPageText(m)}else{drawText(m)}}else{if(n.hasClass("epos-feed-unit")){m=n.find(".attr-feed-unit").val()-0;if(page){drawPageFeed(m)}else{drawFeed(m)}}else{if(n.hasClass("epos-feed-line")){m=n.find(".attr-feed-line").val()-0;if(page){drawPageFeed(m*page_linespc)}else{drawFeed(m*linespc)}}else{if(n.hasClass("epos-feed")){if(page){drawPageFeed(page_linespc)}else{drawFeed(linespc)}}else{if(n.hasClass("epos-feed-pos")){m=a[n.find(".attr-feed-pos").val()];if(page){}else{if(line_w>0){drawFeed(linespc)}drawFixedIcon(n.find("img").get(0),m)}}else{if(n.hasClass("epos-image")){m=a[n.find(".attr-image-color").val()];l=a[n.find(".attr-image-mode").val()];k=n.find(".attr-image-brightness").val()-0;j=a[n.find(".attr-image-halftone").val()];i=n.find(".attr-image-fit").is(":checked");h=n.find(".attr-image").get(0);if(page){drawPageImage(h,m,l,k,j,i)}else{if(line_w==0){drawImage(h,m,l,k,j,i)}}}else{if(n.hasClass("epos-logo")){m=n.find(".attr-logo-key1").val()-0;l=n.find(".attr-logo-key2").val()-0;if(page){drawPageIcon(n.find("img").get(0),m+", "+l,false)}else{if(line_w==0){drawIcon(n.find("img").get(0),m+", "+l)}}}else{if(n.hasClass("epos-barcode")){m=n.find(".attr-barcode-data").val();l=a[n.find(".attr-barcode-type").val()];if(page){drawPageIcon(n.find("img").get(0),l+", "+m,false)}else{if(line_w==0){drawIcon(n.find("img").get(0),l+", "+m)}}}else{if(n.hasClass("epos-symbol")){m=n.find(".attr-symbol-data").val();l=a[n.find(".attr-symbol-type").val()];if(page){drawPageIcon(n.find("img").get(0),l+", "+m,true)}else{if(line_w==0){drawIcon(n.find("img").get(0),l+", "+m)}}}else{if(n.hasClass("epos-hline")){m=n.find(".attr-hline-x1").val()-0;l=n.find(".attr-hline-x2").val()-0;k=a[n.find(".attr-hline-style").val()];if(page){}else{hline.push({x1:Math.min(m,l),x2:Math.max(m,l),style:k})}}else{if(n.hasClass("epos-vline-begin")){m=n.find(".attr-vline-x").val()-0;l=a[n.find(".attr-vline-style").val()];if(page){}else{vline[l+m]={x:m,style:l}}}else{if(n.hasClass("epos-vline-end")){m=n.find(".attr-vline-x").val()-0;l=a[n.find(".attr-vline-style").val()];if(page){}else{delete vline[l+m]}}else{if(n.hasClass("epos-page-begin")){if(page){}else{if(line_w==0&&line_x==0){g=$("#preview-page").get(0);if(g.getContext){f=g.getContext("2d");f.clearRect(0,0,g.width,g.height)}g=$("#preview-area").get(0);if(g.getContext){f=g.getContext("2d");f.clearRect(0,0,g.width,g.height)}page=true;page_h=0;area_x=0;area_y=0;area_w=model.page.ini_w;area_h=model.page.ini_h;area_valid=false;page_dir=dir_convert.left_to_right;page_x=0;page_y=23;vline=[]}}}else{if(n.hasClass("epos-area")){m=n.find(".attr-area-x").val()-0;l=n.find(".attr-area-y").val()-0;k=n.find(".attr-area-width").val()-0;j=n.find(".attr-area-height").val()-0;if(page){moveAreaToPage();area_x=m;area_y=l;area_w=k;area_h=j;area_valid=true;page_x=0;page_y=23}else{}}else{if(n.hasClass("epos-direction")){m=a[n.find(".attr-direction-dir").val()];if(page){page_dir=dir_convert[m];page_x=0;page_y=23}else{}}else{if(n.hasClass("epos-position")){m=n.find(".attr-position-x").val()-0;l=n.find(".attr-position-y").val()-0;if(page){if(m<(page_dir.w?area_w:area_h)){page_x=m}if(l<(page_dir.w?area_h:area_w)){page_y=l}}else{}}else{if(n.hasClass("epos-line")){m=n.find(".attr-line-x1").val()-0;l=n.find(".attr-line-y1").val()-0;k=n.find(".attr-line-x2").val()-0;j=n.find(".attr-line-y2").val()-0;i=a[n.find(".attr-line-style").val()];if(page){drawPageLine(Math.min(m,k),Math.min(l,j),Math.max(m,k),Math.max(l,j),line_convert[i])}else{}}else{if(n.hasClass("epos-rectangle")){m=n.find(".attr-rectangle-x1").val()-0;l=n.find(".attr-rectangle-y1").val()-0;k=n.find(".attr-rectangle-x2").val()-0;j=n.find(".attr-rectangle-y2").val()-0;i=a[n.find(".attr-rectangle-style").val()];if(page){drawPageRect(Math.min(m,k),Math.min(l,j),Math.max(m,k),Math.max(l,j),line_convert[i])}else{}}else{if(n.hasClass("epos-page-end")){if(page){moveAreaToPage();drawPage();page=false}else{}}else{if(n.hasClass("epos-cut")){m=a[n.find(".attr-cut-type").val()];if(page){}else{if(line_w==0&&line_x==0){drawFixedIcon(n.find("img").get(0),m)}}}else{if(n.hasClass("epos-pulse")){m=a[n.find(".attr-pulse-drawer").val()];l=a[n.find(".attr-pulse-time").val()];if(page){}else{if(line_w>0){drawFeed(linespc)}drawFixedIcon(n.find("img").get(0),m+", "+l)}}else{if(n.hasClass("epos-sound")){m=a[n.find(".attr-sound-pattern").val()];l=n.find(".attr-sound-repeat").val()-0;if(page){}else{if(line_w>0){drawFeed(linespc)}drawFixedIcon(n.find("img").get(0),m+", "+l)}}else{if(n.hasClass("epos-layout")){m=a[n.find(".attr-layout-type").val()];if(page){}else{if(line_w>0){drawFeed(linespc)}drawFixedIcon(n.find("img").get(0),m)}}else{if(n.hasClass("epos-recovery")){if(page){}else{drawFixedIcon(n.find("img").get(0),"")}}else{if(n.hasClass("epos-reset")){if(page){}else{drawFixedIcon(n.find("img").get(0),"")}}else{if(n.hasClass("epos-command")){m=n.find(".attr-command-data").val();if(page){drawPageIcon(n.find("img").get(0),m)}else{if(line_w>0){drawFeed(linespc)}drawFixedIcon(n.find("img").get(0),m,false)}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}});if(hline.length>0){drawHLine()}}function drawText(h){var a,f,g,e,b;if(hline.length>0){drawHLine()}a=$("#preview-text").get(0);if(a.getContext){f=a.getContext("2d");f.textAlign="left";f.textBaseline="alphabetic";for(e=0;e<h.length;e++){g=h.charAt(e);switch(g){case"\t":if(line_x==model.width){drawFeed(linespc)}b=font_a*4;line_x=Math.floor(line_x/b)*b+b;if(line_x>model.width){drawFeed(linespc)}break;case"\n":drawFeed(linespc);break;case"\r":break;default:drawChar(f,g);break}}}}function drawChar(e,g){var a,i,b,f;e.font="24px "+font;if(e.measureText(g).width<18){f=model.ank[text_f];if(f==0){f=font_a}else{font_a=f}b=f/2}else{f=model.kanji[text_f];if(f==0){f=font_k}else{font_k=f}b=f}e.font=(f-2)+"px "+font;if(line_x+b*text_w>model.width){drawFeed(linespc)}line_h=Math.max(line_h,f*text_h);a=line_x/text_w;i=line_y/text_h;e.fillStyle=text_c;e.strokeStyle=text_c;e.shadowColor=text_c;e.setTransform(text_w,0,0,text_h,0,0);if(rotate){e.translate(576/text_w,192/text_h);e.rotate(Math.PI)}if(text_r){e.fillRect(a,i,b,-f);c="#f0f0f0";e.fillStyle=c;e.strokeStyle=c;e.shadowColor=c}if(b==f&&text_l=="en"){e.strokeRect(a+2,i-2,b-4,4-f)}else{e.shadowBlur=text_s?2:0;e.fillText(g,a,i-4);if(text_e){e.fillText(g,a+1,i-4)}e.shadowBlur=0}if(text_u){e.fillRect(a,i-1,b,1)}e.setTransform(1,0,0,1,0,0);line_x+=b*text_w;line_w=Math.max(line_w,line_x)}function drawFeed(k){var f,e,m,b,j=0,h,g,a;if(hline.length>0){drawHLine()}f=$("#preview-line").clone().removeAttr("id").attr({width:model.width,height:Math.max(line_h,k)}).get(0);m=$("#preview-text").get(0);if(f.getContext&&m.getContext){e=f.getContext("2d");b=m.getContext("2d");if(line_w>0){if(rotate){if(align!="right"){j=(model.width-line_w)/(align=="left"?1:2)}e.drawImage(m,576-line_w,0,line_w,line_h,j,0,line_w,line_h)}else{if(align!="left"){j=(model.width-line_w)/(align=="right"?1:2)}e.drawImage(m,0,192-line_h,line_w,line_h,j,0,line_w,line_h)}}e.fillStyle="#000000";for(h in vline){g=vline[h];a=line_convert[g.style];e.fillRect(g.x,0,a.w,f.height);if(a.d){e.fillRect(g.x+a.w+1,0,a.w,f.height)}}b.clearRect(0,0,m.width,m.height)}$("#preview-paper").append(f);line_x=0;line_w=0;line_h=0}function drawHLine(){var b,g,f,j,e,a,h;if(line_w>0){hline=[];drawFeed(0)}else{f=$("#preview-text").get(0);if(f.getContext){j=f.getContext("2d");j.fillStyle="#000000";for(e=0;e<hline.length;e++){a=hline[e];h=line_convert[a.style];j.fillRect(a.x1,0,a.x2-a.x1,h.w);if(h.d){j.fillRect(a.x1,h.w+1,a.x2-a.x1,h.w)}line_h=Math.max(line_h,h.d?h.w*2+1:h.w)}b=$("#preview-line").clone().removeAttr("id").attr({width:model.width,height:line_h}).get(0);if(b.getContext){g=b.getContext("2d");g.drawImage(f,0,0,model.width,line_h,0,0,model.width,line_h);g.fillStyle="#000000";for(e in vline){a=vline[e];h=line_convert[a.style];g.fillRect(a.x,0,h.w,b.height);if(h.d){g.fillRect(a.x+h.w+1,0,h.w,b.height)}}j.clearRect(0,0,f.width,f.height)}}$("#preview-paper").append(b);hline=[];line_x=0;line_w=0;line_h=0}}function drawIcon(j,k){var e,g,a=0,f,b,h;if(hline.length>0){drawHLine()}e=$("#preview-line").clone().removeAttr("id").attr({width:model.width,height:48}).get(0);if(e.getContext){g=e.getContext("2d");g.fillStyle="#000000";for(f in vline){b=vline[f];h=line_convert[b.style];g.fillRect(b.x,0,h.w,e.height);if(h.d){g.fillRect(b.x+h.w+1,0,h.w,e.height)}}if(rotate){g.translate(model.width,48);g.rotate(Math.PI)}if(align!="left"){a=(model.width-40)/(align=="right"?1:2)}g.shadowBlur=4;g.shadowColor="#000000";g.drawImage(j,a+4,8);g.shadowBlur=1;g.font="12px sans-serif";g.textBaseline="middle";if(align=="right"){g.textAlign="right";g.fillText(k,a-4,24)}else{g.textAlign="left";g.fillText(k,a+44,24)}g.shadowBlur=0;g.setTransform(1,0,0,1,0,0)}$("#preview-paper").append(e);line_x=0;line_w=0;line_h=0}function drawFixedIcon(e,f){var a,b;if(hline.length>0){drawHLine()}a=$("#preview-line").clone().removeAttr("id").attr({width:model.width,height:48}).get(0);if(a.getContext){b=a.getContext("2d");b.shadowBlur=4;b.shadowColor="#000000";b.drawImage(e,4,8);b.shadowBlur=1;b.font="12px sans-serif";b.textBaseline="middle";b.textAlign="left";b.fillText(f,44,24);b.shadowBlur=0}$("#preview-paper").append(a)}function drawImage(g,j,n,t,r,o){var e,b,q,s,m,p=0,k,f,a;if(hline.length>0){drawHLine()}if(o){s=model.width;m=g.height*s/g.width|0}else{s=Math.min(g.width,model.width);m=g.height}e=$("#preview-line").clone().removeAttr("id").attr({width:model.width,height:m}).get(0);if(e.getContext){b=e.getContext("2d");if(align!="left"&&model.width>s){p=(model.width-s)/(align=="right"?1:2)}if(o){b.drawImage(g,p,0,s,m)}else{b.drawImage(g,0,0,s,m,p,0,s,m)}q=b.getImageData(p,0,s,m);if(n=="gray16"){toGrayImage(q,t)}else{toMonoImage(q,r,t,color_convert[j])}b.putImageData(q,p,0);for(k in vline){f=vline[k];a=line_convert[f.style];b.fillRect(f.x,0,a.w,e.height);if(a.d){b.fillRect(f.x+a.w+1,0,a.w,e.height)}}}$("#preview-paper").append(e);line_x=0;line_w=0;line_h=0}function drawPageText(h){var a,f,g,e,b;if(hline.length>0){drawHLine()}a=$("#preview-area").get(0);if(a.getContext){f=a.getContext("2d");f.textAlign="left";f.textBaseline="alphabetic"}for(e=0;e<h.length;e++){g=h.charAt(e);switch(g){case"\t":if(page_x==(page_dir.w?area_w:area_h)){drawPageFeed(page_linespc)}b=font_a*4;page_x=Math.floor(page_x/b)*b+b;if(page_x>(page_dir.w?area_w:area_h)){drawPageFeed(page_linespc)}break;case"\n":drawPageFeed(page_linespc);break;case"\r":break;default:drawPageChar(f,g);break}}}function drawPageChar(e,g){var a,i,b,f;e.font="24px "+font;if(e.measureText(g).width<18){f=model.ank[text_f];if(f==0){f=font_a}else{font_a=f}b=f/2}else{f=model.kanji[text_f];if(f==0){f=font_k}else{font_k=f}b=f}e.font=(f-2)+"px "+font;if(page_x+b*text_w>(page_dir.w?area_w:area_h)){drawPageFeed(page_linespc)}a=page_x/text_w;i=page_y/text_h;e.fillStyle=text_c;e.strokeStyle=text_c;e.shadowColor=text_c;if(page_dir.w){e.setTransform(text_w,0,0,text_h,0,0);e.translate(page_dir.x*area_w/text_w,page_dir.y*area_h/text_h);e.rotate(page_dir.r)}else{e.setTransform(text_h,0,0,text_w,0,0);e.translate(page_dir.x*area_w/text_h,page_dir.y*area_h/text_w);e.rotate(page_dir.r)}if(text_r){e.fillRect(a,i,b,-f);c="#f0f0f0";e.fillStyle=c;e.strokeStyle=c;e.shadowColor=c}if(b==f&&text_l=="en"){e.strokeRect(a+2,i-2,b-4,4-f)}else{e.shadowBlur=text_s?2:0;e.fillText(g,a,i-4);if(text_e){e.fillText(g,a+1,i-4)}e.shadowBlur=0}if(text_u){e.fillRect(a,i-1,b,1)}e.setTransform(1,0,0,1,0,0);page_x+=b*text_w;area_valid=true}function drawPageFeed(a){page_x=0;page_y+=a}function drawPageIcon(e,f,g){var a,b;a=$("#preview-area").get(0);if(a.getContext){b=a.getContext("2d");b.translate(page_dir.x*area_w,page_dir.y*area_h);b.rotate(page_dir.r);b.shadowBlur=4;b.shadowColor="#000000";b.drawImage(e,page_x+4,page_y+(g?8:-39));b.shadowBlur=1;b.font="12px sans-serif";b.textBaseline="middle";b.textAlign="left";b.fillText(f,page_x+44,page_y+(g?24:-23));b.shadowBlur=0;b.setTransform(1,0,0,1,0,0)}page_x+=48;area_valid=true}function drawPageImage(e,f,i,p,m,j){var b,a,k,o,l,n,g;b=$("#epos-image").get(0);if(j){n=page_dir.w?area_w:area_h;g=e.height*n/e.width|0}else{n=Math.min(e.width,page_dir.w?area_w:area_h);g=e.height}b.width=n;b.height=g;if(i!="gray16"){k=$("#preview-area").get(0);if(b.getContext&&k.getContext){a=b.getContext("2d");o=k.getContext("2d");a.clearRect(0,0,n,g);if(j){a.drawImage(e,0,0,n,g)}else{a.drawImage(e,0,0,n,g,0,0,n,g)}l=a.getImageData(0,0,n,g);toMonoImage(l,m,p,color_convert[f]);a.putImageData(l,0,0);o.translate(page_dir.x*area_w,page_dir.y*area_h);o.rotate(page_dir.r);o.drawImage(b,page_x,page_y-g+1);o.setTransform(1,0,0,1,0,0)}area_valid=true}}function drawPageLine(e,i,a,g,h){var b,f;b=$("#preview-area").get(0);if(b.getContext){f=b.getContext("2d");f.translate(page_dir.x*area_w,page_dir.y*area_h);f.rotate(page_dir.r);f.fillStyle="#000000";if(i==g){f.fillRect(e,i,a-e,h.w);if(h.d){f.fillRect(e,i+h.w+1,a-e,h.w)}}else{if(e==a){f.fillRect(e,i,h.w,g-i);if(h.d){f.fillRect(e+h.w+1,i,h.w,g-i)}}}f.setTransform(1,0,0,1,0,0)}area_valid=true}function drawPageRect(e,i,a,g,h){var b,f;b=$("#preview-area").get(0);if(b.getContext){f=b.getContext("2d");f.translate(page_dir.x*area_w,page_dir.y*area_h);f.rotate(page_dir.r);f.fillStyle="#000000";f.fillRect(e,i,a-e,h.w);f.fillRect(e,i,h.w,g-i);f.fillRect(a,g,e-a,-h.w);f.fillRect(a,g,-h.w,i-g);if(h.d){d=h.w+1;f.fillRect(e+d,i+d,a-e-d-d,h.w);f.fillRect(e+d,i+d,h.w,g-i-d-d);f.fillRect(a-d,g-d,e-a+d+d,-h.w);f.fillRect(a-d,g-d,-h.w,i-g+d+d)}f.setTransform(1,0,0,1,0,0)}area_valid=true}function moveAreaToPage(){var b=$("#preview-area").get(0),f=$("#preview-page").get(0),e,a;if(area_valid){if(b.getContext&&f.getContext){e=b.getContext("2d");a=f.getContext("2d");a.drawImage(b,0,0,area_w,area_h,area_x,area_y,area_w,area_h);e.clearRect(0,0,b.width,b.height)}page_h=Math.max(page_h,area_y+area_h)}}function drawPage(){var e,b,n,f,k,j,g,a,m;k=Math.min(page_h,model.page.max_h);if(k==0){k=model.page.ini_h}e=$("#preview-line").clone().removeAttr("id").attr({width:model.width,height:k}).get(0);n=$("#preview-page").get(0);if(e.getContext&&n.getContext){b=e.getContext("2d");f=n.getContext("2d");b.drawImage(n,0,0,model.width,k,0,0,model.width,k);f.clearRect(0,0,n.width,n.height)}$("#preview-paper").append(e)}function toMonoImage(D,z,I,M){var m=String.fromCharCode,O=[[2,130,34,162,10,138,42,170],[194,66,226,98,202,74,234,106],[50,178,18,146,58,186,26,154],[242,114,210,82,250,122,218,90],[14,142,46,174,6,134,38,166],[206,78,238,110,198,70,230,102],[62,190,30,158,54,182,22,150],[254,126,222,94,246,118,214,86]],L=D.data,o=D.width,H=D.height,a=parseInt(M.slice(1,3),16),u=parseInt(M.slice(3,5),16),B=parseInt(M.slice(5,7),16),E=0,C=0,A=0,y=128,K=new Array(),l,k,N,r,J,G,F;if(z==1){G=o;while(G--){K.push(0)}}for(F=0;F<H;F++){l=0;k=0;G=0;while(G<o){N=G&7;if(z==0){y=O[F&7][N]}r=Math.pow(((L[C++]*0.29891+L[C++]*0.58661+L[C++]*0.11448)*L[C]/255+255-L[C++])/255,1/I)*255|0;if(z==1){r+=K[G]+l>>4;J=r-(r<y?0:255);if(G>0){K[G-1]+=J}K[G]=J*7+k;l=J*5;k=J*3}E=r<y?0:255;L[A++]=Math.max(E,a);L[A++]=Math.max(E,u);L[A++]=Math.max(E,B);L[A++]=255-E;G++}}}function toGrayImage(t,o){var u=String.fromCharCode,A=[[0,9,2,11],[13,4,15,6],[3,12,1,10],[16,7,14,5]],r=t.data,z=t.width,m=t.height,f=0,e=0,a=0,s,B,y,l,k;for(k=0;k<m;k++){l=0;while(l<z){s=l&1;B=Math.pow(((r[e++]*0.29891+r[e++]*0.58661+r[e++]*0.11448)*r[e]/255+255-r[e++])/255,1/o)*255|0;y=B/17|0;if(A[k&3][l&3]<B%17){y++}f=y<<4;r[a++]=f;r[a++]=f;r[a++]=f;r[a++]=255;l++}}};